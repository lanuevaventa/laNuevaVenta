<?php
// filepath: c:\Users\nicot\OneDrive\Desktop\Proyecto\laNuevaVenta\laNuevaVenta-beta-0.1.1-Prubeas\src\generar_admin.php
require_once 'conexion.php';

$password = 'admin123';
$hashed = password_hash($password, PASSWORD_DEFAULT);

echo "<h1>Generador de Admin</h1>";
echo "<p><strong>Contraseña:</strong> $password</p>";
echo "<p><strong>Hash:</strong> $hashed</p>";

// Crear o actualizar el usuario admin
$query = "INSERT INTO Usuario (nombre, apellido, correo, contrasenia, telefono, fecha_registro, rol) 
          VALUES ('Admin', 'Sistema', 'admin@lanuevaventa.com', $1, '123456789', CURRENT_DATE, 'admin')
          ON CONFLICT (correo) DO UPDATE SET contrasenia = $1, rol = 'admin'";

$result = pg_query_params($conexion, $query, [$hashed]);

if ($result) {
    echo "<p style='color: green;'>✅ Usuario admin creado/actualizado exitosamente</p>";
} else {
    echo "<p style='color: red;'>❌ Error: " . pg_last_error($conexion) . "</p>";
}

echo "<hr>";
echo "<h2>Verificar usuario admin:</h2>";
$verify_query = "SELECT * FROM Usuario WHERE correo = 'admin@lanuevaventa.com'";
$verify_result = pg_query($conexion, $verify_query);
$admin_user = pg_fetch_assoc($verify_result);

if ($admin_user) {
    echo "<p><strong>ID:</strong> " . $admin_user['id_usuario'] . "</p>";
    echo "<p><strong>Nombre:</strong> " . $admin_user['nombre'] . " " . $admin_user['apellido'] . "</p>";
    echo "<p><strong>Email:</strong> " . $admin_user['correo'] . "</p>";
    echo "<p><strong>Rol:</strong> " . $admin_user['rol'] . "</p>";
    echo "<p><strong>Hash guardado:</strong> " . substr($admin_user['contrasenia'], 0, 50) . "...</p>";
    
    // Verificar que la contraseña funciona
    if (password_verify($password, $admin_user['contrasenia'])) {
        echo "<p style='color: green;'>✅ Verificación de contraseña exitosa</p>";
    } else {
        echo "<p style='color: red;'>❌ Error en verificación de contraseña</p>";
    }
} else {
    echo "<p style='color: red;'>❌ Usuario admin no encontrado</p>";
}
?>